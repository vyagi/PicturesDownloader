trigger: none

pr:
- master

stages:
- stage: VerifyCode
  displayName: Code verification
  jobs:

  - job: Api
    displayName: Api build & verify
    pool:
      vmImage: windows-latest
    steps:
    - checkout: self

    - task: UseDotNet@2
      inputs:
        version: '8.0.x'

    - script: dotnet build code/Api --configuration Release
      displayName: Build Api

    - script: dotnet test code/ApiTests --configuration Release
      displayName: Test Api

  - job: Downloader
    displayName: Downloader build & verify
    pool:
      vmImage: windows-latest
    steps:
    - checkout: self

    - task: SonarCloudPrepare@4
      inputs:
        SonarQube: 'SonarQubeConnection'
        organization: 'instr1-cloud'
        scannerMode: 'dotnet'
        projectKey: '38c4be1d8308da7d5d41046ae08252840707fa55'

    - task: UseDotNet@2
      inputs:
        version: '8.0.x'

    - script: dotnet build code/Downloader --configuration Release
      displayName: Build Downloader


- stage: TerraformValidate
  displayName: Terraform validation
  dependsOn: VerifyCode
  jobs:

  - job: Terraform
    displayName: Terraform validate
    pool:
      vmImage: windows-latest
    steps:
    - checkout: self
    - task: TerraformInstaller@1
      displayName: Install Terraform
      inputs:
        terraformVersion: '1.6.6'
    - script: |
        cd terraform
        terraform init -backend=false
        terraform validate
      displayName: Terraform init & validate